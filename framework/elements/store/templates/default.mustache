{{#error_message}}<div class="cm-error cm-{{element_type}}-error">{{error_message}}</div>{{/error_message}}
<div class="cm-store cm-front">
<div class="cm-store featured-items">
	{{#features}}

	<div class="cm-store cm-item item-{{id}} featured">
	<div class="cm-store cm-info cm-inner">
		<h2>{{name}}</h2>
		<span class="cm-itemprice">{{currency}}{{price}}{{#flexible_price}} {{copy_flexibleprice_suffix}}{{/flexible_price}}</span>
		<div class="cm-description">{{{description}}}</div>
		{{#is_available}}
		{{#attributes}}
			<select class="cm-attribute" name="{{name}}" data-key="{{key}}" data-itemid="{{id}}" data-totalattributes="{{attributes_count}}" data-attributeorder="{{attribute_index}}">
				<option value="resetattributes" {{#defaultcountermenu}}data-countermenu='{{defaultcountermenu}}'{{/defaultcountermenu}}>{{copy_choose_verb}} {{key}}</option>
				{{#items}}
				<option value="{{key}}" {{#countermenu}}data-countermenu='{{countermenu}}'{{/countermenu}}>{{key}}</option>
				{{/items}}
			</select>
		{{/attributes}}
		{{#flexible_price}}
		<span class="cm-store-flexible-price">
			<span class="cm-store-currency">{{currency}}</span>
			<input type="text" name="total_price" data-itemid="{{id}}" data-atleast="{{price}}" class="cm-price" value="{{price}}" />
		</span>
		{{/flexible_price}}
		<button type="button" data-itemid="{{id}}" data-price="{{price}}" class="button {{#has_variants}}cm-disabled{{/has_variants}} cm-addtocart cm-item-{{id}}"{{#has_variants}} disabled="disabled"{{/has_variants}}>{{#has_variants}}{{copy_choose_variants}}{{/has_variants}}{{^has_variants}}<span class="cm-price">{{currency}}{{price}}</span> - {{copy_cart}}{{/has_variants}}</button>
		{{/is_available}}
		{{^is_available}}
			<span class="cm-unavailable">
				{{copy_unavailable}}
			</span>
		{{/is_available}}
	</div>
	</div>
	{{/features}}
</div><!--featured-->

<a href="#" class="cm-cartbutton">View cart</a>

<div class="cm-store unfeatured-items">
<div class="cm-store cm-info cm-inner">
	<h2 class="title">Also Available</h2>
	{{#items}}
	<div class="cm-store cm-item item-{{id}}">
		<div class="cm-store cm-inner">
		<h2>{{name}}</h2>
		<span class="cm-itemprice">{{currency}}{{price}}{{#flexible_price}} {{copy_flexibleprice_suffix}}{{/flexible_price}}</span>
		<div class="cm-description">{{{description}}}</div>
		{{#is_available}}
		{{#attributes}}
			<select class="cm-attribute" name="{{name}}" data-key="{{key}}" data-itemid="{{id}}" data-totalattributes="{{attributes_count}}" data-attributeorder="{{index}}">
				<option value="resetattributes" {{#defaultcountermenu}}data-countermenu='{{defaultcountermenu}}'{{/defaultcountermenu}}>{{copy_choose_verb}} {{key}}</option>
				{{#items}}
				<option value="{{key}}" {{#countermenu}}data-countermenu='{{countermenu}}'{{/countermenu}}>{{key}}</option>
				{{/items}}
			</select>
		{{/attributes}}
		{{#flexible_price}}
		<span class="cm-store-flexible-price">
			<span class="cm-store-currency">{{currency}}</span>
			<input type="text" name="total_price" data-itemid="{{id}}" data-atleast="{{price}}" class="cm-price" value="{{price}}" />
		</span>
		{{/flexible_price}}
		<button type="button" data-itemid="{{id}}" data-price="{{price}}" class="button {{#has_variants}}cm-disabled{{/has_variants}} cm-addtocart cm-item-{{id}}"{{#has_variants}} disabled="disabled"{{/has_variants}}>{{#has_variants}}{{copy_choose_variants}}{{/has_variants}}{{^has_variants}}<span class="cm-price">{{currency}}{{price}}</span> - {{copy_cart}}{{/has_variants}}</button>
		{{/is_available}}
		{{^is_available}}
			<span class="cm-unavailable">
				{{copy_unavailable}}
			</span>
		{{/is_available}}
		</div>
	</div>
	{{/items}}
	</div>
</div><!--unfeatured-->

</form>

</div><!--cm-store cm-front-->

<script type="text/javascript">
	var cm = window.cashmusic;
	var cartpresent = false;
	var cartbuttonbusy = false;

	cm.events.add(cm,'ready', function(e) {
		function flashCartButton() {
			if (cartpresent) {
				if (!cartbuttonbusy) {
					cm.styles.addClass('storage:cartbutton','cm-flash',true);
					cartbuttonbusy = true;
					setTimeout(function() {
						cm.styles.removeClass('storage:cartbutton','cm-flash',true);
						cartbuttonbusy = false;
					},2000);
				}
			} else {
				addCartButton();
			}
		}

		function addCartButton() {
			cm.overlay.addOverlayTrigger({"element":"{{element_id}}","endpoint":"{{public_url}}","state":"cart"},'cm-cartbutton cm-flash','cartbutton');
			cartbuttonbusy = true;
			setTimeout(function() {
				cm.styles.removeClass('storage:cartbutton','cm-flash',true);
				cartbuttonbusy = false;
			},2000);
			cartpresent = true;
		}

		// Bag icon by Mike Ashley for the Noun Project
		var css = ".cm-cartbutton {position:fixed;top:40px;right:40px;width:40px;height:40px;border-radius:40px;z-index:54321;cursor:pointer;background:#111 url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' x='0px' y='0px' width='119px' height='105px' viewBox='0 0 119 105' enable-background='new 0 0 119 105' xml:space='preserve'><g><path fill='#FFFFFF' d='M117.854,28.504c0-1.454,0-2.908,0-5.182c-9.478,0-18.482,0-28.488,0C93.695,10.866,83.843,7.781,76.854,1 c0,8.348,0,15.22,0,22.165c-11.793,0-23.049,0-34.93,0c0-7.136,0-13.975,0-21.526c-7.168,6.224-16.052,10.232-12.473,21.922 c-9.618,0-18.204,0-27.304,0c0,20.887-0.014,40.866,0.005,60.844c0.013,13.215,6.387,19.578,19.602,19.584 c25.479,0.013,50.959,0.012,76.439,0.001c13.252-0.006,19.632-6.328,19.653-19.53C117.875,65.808,117.854,47.156,117.854,28.504z M84.411,59.874c-1.407,3.764-3.839,7.461-6.691,10.303c-5.618,5.597-11.853,10.576-17.77,15.758 c-6.029-5.341-12.384-10.664-18.364-16.377c-3.891-3.718-6.715-8.133-6.699-14c0.016-5.785,2.226-10.151,7.43-12.471 c5.321-2.373,10.423-1.436,14.813,2.568c0.854,0.779,1.673,1.596,2.739,2.615c0.912-0.785,1.772-1.49,2.596-2.238 c4.9-4.449,11.633-5.428,16.539-2.393C84.227,46.87,86.818,53.438,84.411,59.874z'/> <path fill='#FFFFFF' d='M75.479,1.414c-10.799,0-21.994,0-32.135,0c0,3.412,0,6.453,0,9.379c10.591,0,21.784,0,32.135,0 C75.479,7.521,75.479,4.614,75.479,1.414z'/></g></svg>\") no-repeat 50% 46%;background-size:50%;vertical-align:middle;}";
		   css += ".cm-cartbutton:hover{-webkit-animation: modalrotate ease-out 0.5s;-moz-animation: modalrotate ease-out 0.5s;animation: modalrotate ease-out  0.5s;}";
		   css += "@-webkit-keyframes flash {0% {-webkit-transform: scale(0.3);}50% { -webkit-transform: scale(1.1);}100% { -webkit-transform: scale(1);}}";
		   css += "@keyframes flash {0% {transform: scale(0.3);}50% {transform: scale(1.1);}100% {transform: scale(1);}}";
		   css += ".cm-flash{animation-name:flash;animation-duration: 1s;animation-timing-function: ease-out;animation-iteration-count: 1;-webkit-animation-name: flash;-webkit-animation-duration: 1s;-webkit-animation-timing-function: ease-out;-webkit-animation-iteration-count:1;}";
		cm.styles.injectCSS(css,false,true);

		{{#items_in_cart}}
			addCartButton();
		{{/items_in_cart}}

		// sort all the cart buttons
		var buttons = document.querySelectorAll('.cm-addtocart');
		if (buttons.length > 0) {
			for (var i = 0, len = buttons.length; i < len; i++) {
				cm.events.add(buttons[i],'click', function(e) {
					if (this.innerHTML != '{{copy_added}}') {
						var requesturl = '{{api_url}}/verbose/commerce/addtocart/item_id/' + this.getAttribute('data-itemid') + '/price/' + this.getAttribute('data-price') + '/';
						if (this.getAttribute('data-variantid')) {
							requesturl += 'item_variant/'+this.getAttribute('data-variantid')+'/'
						}
						cm.ajax.send(requesturl, false,
							function(r) {
								flashCartButton();
								var el = e.target;
								if(e.target.getAttribute('type') != 'button') {
									el = e.target.parentNode; // if the span is clicked use the button parent
								}
								var returnTxt = e.target.innerHTML;
								el.innerHTML = '{{copy_added}}';
								setTimeout(function() {
									el.innerHTML = returnTxt;
								},2200);
							}
						);
					}
					e.preventDefault();
					return false;
				});
			}
		}

		// keep prices correct
		var prices = document.querySelectorAll('input.cm-price');
		if (prices.length > 0) {
			for (var i = 0, len = prices.length; i < len; i++) {
				cm.events.add(prices[i],'keyup', function(e) {
					var newprice = parseFloat(this.value);
					if (newprice) {
						if (newprice > this.getAttribute('data-atleast')) {
							var pricespan = document.querySelector('button.cm-addtocart.cm-item-' + this.getAttribute('data-itemid') + ' span.cm-price');
							if (pricespan) {
								pricespan.innerHTML = '{{currency}}' + newprice.toFixed(2);
							}
							document.querySelector('button.cm-addtocart.cm-item-' + this.getAttribute('data-itemid')).setAttribute('data-price',newprice.toFixed(2))
						}
					}
					e.preventDefault();
					return false;
				});

				cm.events.add(prices[i],'blur', function(e) {
					this.value = document.querySelector('button.cm-addtocart.cm-item-' + this.getAttribute('data-itemid')).getAttribute('data-price');
				});
			}
		}

		// i hate you, item variants
		// to clarify, i hate the dropdown logic not the variants.
		// the variants were lovingly crafted by @waferbaby and they're very nice
		var attributes = document.querySelectorAll('select.cm-attribute');
		if (attributes.length > 0) {
			for (var i = 0, len = attributes.length; i < len; i++) {
				cm.events.add(attributes[i],'change', function(e) {
					var otherselect = e.target.parentNode.querySelector('select:not([name="'+e.target.getAttribute('name')+'"]');
					var b = document.querySelector('button.cm-addtocart.cm-item-' + e.target.getAttribute('data-itemid'));
					if (otherselect) {
						var supportedoptions = JSON.parse(e.target.options[e.target.selectedIndex].getAttribute('data-countermenu'));
						var otheroptions = otherselect.querySelectorAll('option');
						for (var i = 0, len = otheroptions.length; i < len; i++) {
							otheroptions[i].setAttribute('disabled','disabled');
							if (otheroptions[i].value == 'resetattributes' || supportedoptions.indexOf(otheroptions[i].value) !== -1) {
								otheroptions[i].removeAttribute('disabled');
							}
						}
						if (e.target.value != 'resetattributes' && otherselect.value != 'resetattributes') {
							var thisid = e.target.getAttribute('data-key')+'->'+e.target.value;
							var otherid = otherselect.getAttribute('data-key')+'->'+otherselect.value;
							if (e.target.getAttribute('data-attributeorder') == 0) {
								var attributekey = thisid+'+'+otherid;
							} else {
								var attributekey = otherid+'+'+thisid;
							}
							b.setAttribute('data-variantid',attributekey);
							b.removeAttribute('disabled');
							b.innerHTML = '<span class="cm-price">{{currency}}'+b.getAttribute('data-price')+'</span> - {{copy_cart}}';
						} else {
							b.removeAttribute('data-variantid');
							b.setAttribute('disabled','disabled');
							b.innerHTML = '{{copy_choose_variants}}';
						}
					}
					if (e.target.getAttribute('data-totalattributes') == 1) {
						if (e.target.value != 'resetattributes') {
							b.setAttribute('data-variantid',e.target.getAttribute('data-key')+'->'+e.target.value);
							b.removeAttribute('disabled');
							b.innerHTML = '<span class="cm-price">{{currency}}'+b.getAttribute('data-price')+'</span> - {{copy_cart}}';
						} else {
							b.removeAttribute('data-variantid');
							b.setAttribute('disabled','disabled');
							b.innerHTML = '{{copy_choose_variants}}';
						}
					}
				});
			}
		}
	});
</script>
