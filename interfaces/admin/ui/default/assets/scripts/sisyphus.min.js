(function(b){function g(b){return"[id="+b.attr("id")+"][name="+b.attr("name")+"]"}b.fn.sisyphus=function(d){var f=b.map(this,function(f){return g(b(f))}).join(),f=Sisyphus.getInstance(f);f.protect(this,d);return f};var m={isAvailable:function(){if("object"===typeof b.jStorage)return!0;try{return localStorage.getItem}catch(d){return!1}},set:function(d,f){if("object"===typeof b.jStorage)b.jStorage.set(d,f+"");else try{localStorage.setItem(d,f+"")}catch(g){}},get:function(d){return"object"===typeof b.jStorage?
(d=b.jStorage.get(d))?d.toString():d:localStorage.getItem(d)},remove:function(d){"object"===typeof b.jStorage?b.jStorage.deleteKey(d):localStorage.removeItem(d)}};Sisyphus=function(){function d(){return{setInstanceIdentifier:function(a){this.identifier=a},getInstanceIdentifier:function(){return this.identifier},setInitialOptions:function(a){var h={excludeFields:[],customKeySuffix:"",locationBased:!1,timeout:0,autoRelease:!0,onBeforeSave:function(){},onSave:function(){},onBeforeRestore:function(){},
onRestore:function(){},onRelease:function(){}};this.options=this.options||b.extend(h,a);this.browserStorage=m},setOptions:function(a){this.options=this.options||this.setInitialOptions(a);this.options=b.extend(this.options,a)},protect:function(a,h){this.setOptions(h);a=a||{};var c=this;this.targets=this.targets||[];this.href=c.options.name?c.options.name:location.hostname+location.pathname+location.search+location.hash;this.targets=b.merge(this.targets,a);this.targets=b.unique(this.targets);this.targets=
b(this.targets);if(!this.browserStorage.isAvailable())return!1;var e=c.options.onBeforeRestore.call(c);(void 0===e||e)&&c.restoreAllData();this.options.autoRelease&&c.bindReleaseData();if(!f.started[this.getInstanceIdentifier()])if(c.isCKEditorPresent())var d=setInterval(function(){k.isLoaded&&(clearInterval(d),c.bindSaveData(),f.started[c.getInstanceIdentifier()]=!0)},100);else c.bindSaveData(),f.started[c.getInstanceIdentifier()]=!0},isCKEditorPresent:function(){return this.isCKEditorExists()?(k.isLoaded=
!1,k.on("instanceReady",function(){k.isLoaded=!0}),!0):!1},isCKEditorExists:function(){return"undefined"!==typeof k},findFieldsToProtect:function(a){return a.find(":input").not(":submit").not(":reset").not(":button").not(":file").not(":password").not(":disabled").not("[readonly]")},bindSaveData:function(){var a=this;a.options.timeout&&a.saveDataByTimeout();a.targets.each(function(){var h=g(b(this));a.findFieldsToProtect(b(this)).each(function(){if(-1!==b.inArray(this,a.options.excludeFields))return!0;
var c=b(this),e=(a.options.locationBased?a.href:"")+h+g(c)+a.options.customKeySuffix;if(c.is(":text")||c.is("textarea"))a.options.timeout||a.bindSaveDataImmediately(c,e);a.bindSaveDataOnChange(c)})})},saveAllData:function(){var a=this;a.targets.each(function(){var h=g(b(this)),c={};a.findFieldsToProtect(b(this)).each(function(){var e=b(this);if(-1!==b.inArray(this,a.options.excludeFields)||void 0===e.attr("name")&&void 0===e.attr("id"))return!0;var f=(a.options.locationBased?a.href:"")+h+g(e)+a.options.customKeySuffix,
d=e.val();if(e.is(":checkbox")){var l=e.attr("name");if(void 0!==l&&-1!==l.indexOf("[")){if(!0===c[l])return;d=[];b("[name='"+l+"']:checked").each(function(){d.push(b(this).val())});c[l]=!0}else d=e.is(":checked");a.saveToBrowserStorage(f,d,!1)}else e.is(":radio")?e.is(":checked")&&(d=e.val(),a.saveToBrowserStorage(f,d,!1)):a.isCKEditorExists()?(l=k.instances[e.attr("name")]||k.instances[e.attr("id")])?(l.updateElement(),a.saveToBrowserStorage(f,e.val(),!1)):a.saveToBrowserStorage(f,d,!1):a.saveToBrowserStorage(f,
d,!1)})});a.options.onSave.call(a)},restoreAllData:function(){var a=this,h=!1;a.targets.each(function(){var c=b(this),e=g(b(this));a.findFieldsToProtect(c).each(function(){if(-1!==b.inArray(this,a.options.excludeFields))return!0;var c=b(this),d=(a.options.locationBased?a.href:"")+e+g(c)+a.options.customKeySuffix,d=a.browserStorage.get(d);null!==d&&(a.restoreFieldsData(c,d),h=!0)})});h&&a.options.onRestore.call(a)},restoreFieldsData:function(a,b){if(void 0===a.attr("name")&&void 0===a.attr("id"))return!1;
var c=a.attr("name");!a.is(":checkbox")||"false"===b||void 0!==c&&-1!==c.indexOf("[")?!a.is(":checkbox")||"false"!==b||void 0!==c&&-1!==c.indexOf("[")?a.is(":radio")?a.val()===b&&a.prop("checked",!0):(void 0!==c&&-1!==c.indexOf("[")&&(b=b.split(",")),a.val(b)):a.prop("checked",!1):a.prop("checked",!0)},bindSaveDataImmediately:function(a,b){var c=this;"onpropertychange"in a?a.get(0).onpropertychange=function(){c.saveToBrowserStorage(b,a.val())}:a.get(0).oninput=function(){c.saveToBrowserStorage(b,
a.val())};if(this.isCKEditorExists()){var e=k.instances[a.attr("name")]||k.instances[a.attr("id")];if(e)e.document.on("keyup",function(){e.updateElement();c.saveToBrowserStorage(b,a.val())})}},saveToBrowserStorage:function(a,b,c){var e=this.options.onBeforeSave.call(this);if(void 0===e||!1!==e)c=void 0===c?!0:c,this.browserStorage.set(a,b),c&&""!==b&&this.options.onSave.call(this)},bindSaveDataOnChange:function(a){var b=this;a.change(function(){b.saveAllData()})},saveDataByTimeout:function(){var a=
this;setTimeout(function(){function b(){a.saveAllData();setTimeout(b,1E3*a.options.timeout)}return b}(a.targets),1E3*a.options.timeout)},bindReleaseData:function(){var a=this;a.targets.each(function(){var d=b(this),c=g(d);b(this).bind("submit reset",function(){a.releaseData(c,a.findFieldsToProtect(d))})})},manuallyReleaseData:function(){var a=this;a.targets.each(function(){var d=b(this),c=g(d);a.releaseData(c,a.findFieldsToProtect(d))})},releaseData:function(a,d){var c=!1,e=this;f.started[e.getInstanceIdentifier()]=
!1;d.each(function(){if(-1!==b.inArray(this,e.options.excludeFields))return!0;var d=b(this),d=(e.options.locationBased?e.href:"")+a+g(d)+e.options.customKeySuffix;e.browserStorage.remove(d);c=!0});c&&e.options.onRelease.call(e)}}}var f={instantiated:[],started:[]},k=window.CKEDITOR;return{getInstance:function(a){f.instantiated[a]||(f.instantiated[a]=d(),f.instantiated[a].setInstanceIdentifier(a),f.instantiated[a].setInitialOptions());return f.instantiated[a]},free:function(){f={instantiated:[],started:[]};
return null},version:"1.1.2"}}()})(jQuery);
