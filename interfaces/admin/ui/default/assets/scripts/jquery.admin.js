/**
 * JavaScript behaviors for the CASH admin
 * Copyright (c) 2015, CASH Music
 * See jquery.admin.full.js for full LICENSE
 *
 **/
 jQuery.fn.extend({insertAtCaret:function(a){return this.each(function(f){if(document.selection)this.focus(),document.selection.createRange().text=a,this.focus();else if(this.selectionStart||"0"==this.selectionStart){f=this.selectionStart;var h=this.selectionEnd,q=this.scrollTop;this.value=this.value.substring(0,f)+a+this.value.substring(h,this.value.length);this.focus();this.selectionStart=f+a.length;this.selectionEnd=f+a.length;this.scrollTop=q}else this.value+=a,this.focus()})}});
 (function(a){var f,h,q,l,m;function y(b,c,d,k,e){a.ajax({type:"POST",url:b,data:c+"data_only=1",success:function(g){g?(g.initiallogin&&(a("body").removeClass("login"),a("#loadingmask").css("width","1%")),g.template_name&&0<=g.template_name.toLowerCase().indexOf("login")&&(a("body").addClass("login"),history.pushState(1,null,cashAdminPath+"/")),"doredirect"in g||(g.doredirect=!1),g.doredirect?g.showerror?n(g.location,!1,g.showerror):g.showmessage?n(g.location,!1,!1,g.showmessage):n(g.location):(d&&
 (g.error_message=d),k&&(g.page_message=k),a("#mainspc, #pagetitle, #page").removeClass(),a("#mainspc, #page").addClass(g.specialcolor),G(g.section_name),a("#pagemessage").html(""),g.error_message&&r(g.error_message,"Error",!0),g.page_message&&r(g.page_message,""),""!=g.ui_page_tip?(a("#learn_tip").html(g.ui_page_tip),a("#learn_tip").css("display","block")):a("#learn_tip").css("display","none"),a("#learn_text").html(g.ui_learn_text),a("#page_content").html(g.content),a("#pagetitle span").html(g.ui_title),
 window.scrollTo(0,0),a(document).trigger("redraw"),e||history.pushState(1,null,b),z()),a("#ajaxloading, #logo, #hero, #learnpanel, #settingspanel, #helppanel").removeClass("loading"),a("#pagedisplay").fadeTo(200,1)):y(b,c,d,k,e)},error:function(a,b,c){console.log(b+": "+c)},dataType:"json"})}function n(b,c,d,k,e){c=c?c+"&":"";a(".modallightbox").fadeOut("fast",function(){a(".modallightbox").remove()});a(".modalbg").fadeOut("fast",function(){a(".modalbg").remove()});t();a("#ajaxloading, #logo, #hero, #learnpanel, #settingspanel, #helppanel").addClass("loading");
 a("#pagedisplay").fadeTo(100,.2,function(){y(b,c,d,k,e)})}function z(){t();A('<div class="icon icon-arw-up"></div>\x3c!--icon--\x3eHide','<div class="icon icon-arw-dwn"></div>\x3c!--icon--\x3eShow');v();a("input[type=date],input.date").datepicker();u();H();I();J();B();K()}function L(){M();N();O();P();Q();R();S();T();a(document).on("click","#tipslink",function(b){b.preventDefault();a("#pagetips").slideDown(200)});a(document).on("click","#tipscloselink",function(b){b.preventDefault();a("#pagetips").slideUp(100)});
 a(document).on("swipeleft","#page",function(b){a("body").removeClass("swiperight");a("body").hasClass("swipeleft")||a("body").hasClass("swiperight")||a("body").addClass("swipeleft")});a(document).on("swiperight","#page",function(b){a("body").removeClass("swipeleft");a("body").hasClass("swipeleft")||a("body").hasClass("swiperight")||a("body").addClass("swiperight")});a(document).on("click","#menutoggle",function(b){a("#menutoggle").toggleClass("display");a("#navmenu").toggleClass("display")});a(document).on("click",
 "#searchbtn",function(b){a("#searchbtn").toggleClass("display");a("#search").toggleClass("display")});a(document).on("click","a.injectcode",function(b){b.preventDefault();a("#template")&&a("#template").insertAtCaret("{{{element_"+a(this).data("elementid")+"}}}")});a(document).on("click","#flipback",function(b){a("#flipback").parent().removeClass("display");t()});a(document).on("click","input.externalsubmit",function(b){a(a(this).data("cash-target-form")).submit()});a(document).on("change","#current-campaign",
 function(b){a(this).closest("form").submit()});a(document).on("change","#current-published-campaign",function(b){a(this).find(":selected").data("template")?r("","This will change your public page. Are you sure?",!0,a(this).find(":selected").data("path")):r("","Before you can publish this campaign, you need to set its page theme. Open the campaign and click the edit icon to start.",!0)});a(document).on("click",".codearea",function(a){element=this;if(document.body.createTextRange)a=document.body.createTextRange(),
 a.moveToElementText(element),a.select();else if(window.getSelection){var c=window.getSelection();a=document.createRange();a.selectNodeContents(element);c.removeAllRanges();c.addRange(a)}});a(document).on("click",".multipart-next",function(b){b.preventDefault();var c=!1;a(a(h).children(".part-"+f)[0]).find("input,select,textarea").each(function(){if(!C.element(a(this)))return c=!0,!1});c||(a(h.children(".part-"+f)[0]).hide(),f+=1,f>l?(a(a(h).children(".section.basic-information")[0]).fadeIn(),a(m).text("Finalize: "+
 a(a(h).children(".section.basic-information")[0]).data("section-name")),a(q).show()):(a(a(h).children(".part-"+f)[0]).fadeIn(),a(m).text("Step "+f+" of "+l+": "+a(a(h).children(".part-"+f)[0]).data("section-name"))))});a(document).on("click",".multipart-prev",function(b){b.preventDefault();a(h.children(".part-"+f)[0]).hide();--f;a(a(h).children(".part-"+f)[0]).fadeIn();a(m).text("Step "+f+" of "+l+": "+a(a(h).children(".part-"+f)[0]).data("section-name"))});a(document).on("click",'.store a[href^="'+
 cashAdminPath+'/elements/add"]',function(b){b.preventDefault();b.stopPropagation();jQuery.post(this.href,"data_only=1",function(b){a("div.modallightbox").html("<h4>"+b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div>');a(".store .modallightbox h4").css("width","62%");a(document).bind("scroll",w);D();u()},"json")});a(document).on("click",".revealpassword",function(b){b.preventDefault();
 a(b.target).prev('input[type="password"]').attr("value");a(b.target).parent().children(".needsreveal").each(function(){var b=a(this).prop("value");"password"==a(this).prop("type")?a(this).attr("type","text"):a(this).attr("type","password");a(this).attr("value",b)})});a(document).on("mouseenter",".featured-release",function(b){a("#card",this).addClass("flipped")});a(document).on("mouseleave",".featured-release",function(b){a("#card",this).removeClass("flipped")});a(document).on("click",".toggle",function(b){a(this).parent().toggleClass("display")});
 a(document).on("click",".paneltitle",function(a){t()});a(document).on("click","#learn.toggle, #learnpanel .toggle",function(b){a("body").removeClass("help").removeClass("settings");a(this).parents("body").addClass("panel").addClass("learn")});a(document).on("click","#settings.toggle, #settingspanel .toggle, .settings.toggle",function(b){a("body").removeClass("help").removeClass("learn");a(this).parents("body").addClass("panel").addClass("settings");a("#settingspanel .tertiarynav li a").removeClass("current");
 x(cashAdminPath+"/account/");a("#settingspanel .tertiarynav li a:first").addClass("current")});a(document).on("click","#help.toggle, #helppanel .toggle",function(b){a("body").removeClass("settings").removeClass("learn");a(this).parents("body").addClass("panel").addClass("help");a("#helppanel .tertiarynav li a").removeClass("current");x(cashAdminPath+"/help/");a("#helppanel .tertiarynav li a:first").addClass("current")});a(document).on("click",".swipehint",function(b){a(this).addClass("hide")})}function x(b){a.post(b,
 "data_only=1",function(b){a("body").hasClass("help")?a("#helppanel .panelcontent").html(a(b.content)):a("body").hasClass("settings")&&a("#settingspanel .panelcontent").html(a(b.content));u()})}function t(){a("body").removeClass("panel").removeClass("help").removeClass("settings").removeClass("learn")}function J(){if(a("#cnvs").length){var b=a("#cnvs").data("seed");if(b){var c=b.toString().split("").reverse(),b=Math.ceil((Number(c[0])+1)/2),d=Math.ceil((Number(c[1])+1)/2),k="250,56,102 106,56,250 255,124,18 250,56,56 0,207,127 250,56,102 106,56,250 255,124,18 250,56,56 0,207,127".split(" "),
 e=["0.9","0.6","0.3"],g=[9,24,60,980,120,180,210,240,270,330],f=new Image;f.src=cashAdminPath+"/assets/images/glitch/background/glitch"+b+".jpg";f.addEventListener("load",function(){var b=a("#cnvs").width(),h=a("#cnvs").height(),l=document.getElementById("cnvs").getContext("2d");l.drawImage(f,0,0);olay=new Image;olay.src=cashAdminPath+"/assets/images/glitch/artist/artist"+d+".jpg";olay.addEventListener("load",function(){l.globalCompositeOperation="screen";for(var d=0;2E3>d;)l.drawImage(olay,olay.width/
 (5*(Number(c[2])+1))+d/3,0,g[Number(c[2])],h,d,0,g[Number(c[2])],h),d+=g[Number(c[2])];l.save();l.globalCompositeOperation="hard-light";d=l.createLinearGradient(0,0,a("#cnvs").width()/2,0);d.addColorStop(0,"rgba("+k[Number(c[3])]+","+e[Number(c[3])%3]+")");d.addColorStop(1,"rgba("+k[Number(c[4])]+","+e[Number(c[3])%3]+")");l.fillStyle=d;l.fillRect(0,0,b,h);l.restore();a("#cnvs").addClass("display")},!1)},!1)}}}function S(){a(document).on("mouseenter",".elementdisplay",function(b){if(!a(this).hasClass("injectcode")){b.preventDefault();
 var c=a(this).attr("name");window.globaltimeout=window.setTimeout(function(){a(".gallery").stop().animate({scrollLeft:Math.floor(a(c).position().left)-34},"slow")},150);a(".example").removeClass("current");a(".gallery "+c).addClass("current")}});a(document).on("mouseleave",".elementdisplay",function(a){a.preventDefault();window.globaltimeout&&window.clearTimeout(window.globaltimeout)})}function B(){ZeroClipboard.config({swfPath:cashAdminPath+"/ui/default/assets/flash/ZeroClipboard.swf"});var b=new ZeroClipboard(a(".copy"));
 b.on("ready",function(a){b.on("aftercopy",function(a){alert("Embed Code Copied To Clipboard.")})})}function M(){a(document).on("click",'a[href^="'+cashAdminPath+'"]',function(b){var c=a(b.currentTarget);b.altKey||b.ctrlKey||b.metaKey||b.shiftKey||c.hasClass("lightboxed")||c.hasClass("needsconfirmation")||c.hasClass("showelementdetails")||c.hasClass("noajax")||c.parents("div").hasClass("inner")||a("body").hasClass("store")||!c.attr("href").indexOf("elements/add")||a("body").hasClass("page-editor")||
 c.hasClass("connection")?!c.parents("div").hasClass("inner")||c.hasClass("connection")||c.hasClass("lightboxed")||c.hasClass("needsconfirmation")?c.hasClass("store")?(b.preventDefault(),a("body").addClass("store")):c.hasClass("page-editor")&&(b.preventDefault(),a("body").addClass("page-editor")):(b.preventDefault(),a(".panelcontent").removeClass("display"),b=c.attr("href"),x(b),a(".panelcontent").addClass("display"),a(".inner a").removeClass("current"),c.addClass("current"),c.blur()):(b.preventDefault(),
 b=c.attr("href"),n(b),c.blur())})}function u(){a("form").each(function(){C=a(this).validate({errorClass:"invalid",errorElement:"span",highlight:function(b,c){a(b).addClass(c);a(b.form).find("label[for="+b.id+"]").addClass(c)},unhighlight:function(b,c){a(b).removeClass(c);a(b.form).find("label[for="+b.id+"]").removeClass(c)},submitHandler:function(b){if(1>a(b).attr("action").toLowerCase().indexOf("s3.amazonaws")&&!a(b).hasClass("noajax")){b=a(b);var c=b.attr("action");""==c&&(c=location.pathname);
 var d=a(b).serialize();b.hasClass("returntocurrentroute")&&(d+="&forceroute="+location.pathname.replace(cashAdminPath,""));n(c,d)}else b.submit()}})})}function G(b){b!=currentSection&&(currentSection=b,a("div.mainnavmenu li").each(function(c){a(this).removeClass("current");a(this).hasClass(b+"nav")&&a(this).addClass("current")}),a("div.mainnavmenu a").each(function(c){a(this).hasClass(b+"nav")&&a(this).parent().addClass("current")}))}function I(){a("#connection_id").each(function(){if(0<this.value){var b=
 a(".file-upload-trigger").data("upload-endpoint")+this.value;a(".upload-corral").fadeIn().find(".file-upload-trigger").data("upload-endpoint",b)}})}function N(){a(document).on("click","a[data-publicize-endpoint]",function(b){b.preventDefault();a.ajax({url:a(this).data("publicize-endpoint"),dataType:"json"}).done(function(a){}).complete(function(b){b=a.parseJSON(b.responseText);b.success&&(a("#asset_location").val(b.location),a("#connection_id").val("0"),a(".upload-corral").fadeOut())})});a(document).on("change",
 "#connection_id",function(b){if(0<this.value){b=a(".file-upload-trigger").data("upload-endpoint")+this.value;var c=a(".upload-corral").fadeIn().find(".file-upload-trigger");c.data("upload-endpoint",b);a.ajax({url:b,dataType:"json",data:"data_only=1"}).done(function(a){c.parents(".drawer").find(".drawercontent").html(a.content)})}else a(".upload-corral").fadeOut()});a(document).on("click",".file-upload-trigger",function(b){b.preventDefault();b=a(this);a(this).data("upload-endpoint");if("0"==a("#connection_id").val())return alert("Sorry, can't upload without a connection. Have you tried a normal link?"),
 !1;b.parents(".fadedtext").css("height","0px");b.parents(".fadedtext").animate({opacity:0})})}function H(){a(".autocomplete").each(function(){var b=a(this).data("cash-endpoint-url");a(this).autocomplete({source:function(c,d){a.ajax({url:b+"/"+c.term,dataType:"json",error:function(a){},success:function(b){d(a.map(b,function(a){return{label:a.displayString,value:a.displayString,id:a.id}}))}})},select:function(b,d){a("#event_venue").val(d.item.id)},minLength:2})})}function O(){a(document).on("click",
 ".modalcancel, .modalskip",function(a){a.preventDefault();E()});a(document).on("click",".page-description",function(b){a("body").hasClass("settings")||a("body").hasClass("help")?(a("body").removeClass("settings").removeClass("help"),a("body").addClass("learn"),a(this).addClass("display")):a("body").hasClass("learn")?(a("body").removeClass("panel"),window.globaltimeout=window.setTimeout(function(){a("body").removeClass("learn").removeClass("settings").removeClass("help")},250)):(a(this).parents("body").addClass("learn").addClass("panel"),
 a(this).addClass("display"))});a(document).keyup(function(a){27===a.keyCode&&E()})}function E(){a(".modallightbox").fadeOut("fast",function(){a(".modallightbox").remove();openlightbox=!1});a(".modalbg").fadeOut("fast",function(){a(".modalbg").remove();a("body").removeClass("store page-editor")});a(document).unbind("scroll",w)}function Q(){a(document).on("click",".needsconfirmation",function(b){b.preventDefault();r("","Are you sure?",!0,a(this).attr("href"));this.blur()});a(document).on("click",".lightboxed",
 function(b){b.preventDefault();a(this).hasClass("closepanel")&&t();a(this).hasClass("returntocurrentroute")?F(a(this).attr("href"),!0):F(a(this).attr("href"));this.blur()})}function K(){a("div.switchblock").each(function(){var b=a(a(this).data("watch"));if(b){var c=a(this).data("change");b.change(function(){a(c).addClass("show")});var d=b.val(),k=a(this).data("special");if(k&&"object"===typeof k)if(k.val){if(d==k.val&&a(k.target))return a(k.target).addClass("show"),b.change(function(){a(k.target).removeClass("show")}),
 !0}else a.each(k,function(c,e){if(d==e.val&&a(e.target))return a(e.target).addClass("show"),b.change(function(){a(e.target).removeClass("show")}),!0});var e=a(this).data("default");a(e).addClass("show");e!==c&&b.change(function(){a(e).removeClass("show")})}})}function r(b,c,d,k){c='<div class="modalbg"><div class="modaldialog"><div class="pure-u-1"><h4>'+c+"</h4>";b&&(c+='<p><span class="big">'+b+"</span></p>");d&&k&&(c+='<input type="button" class="button modalcancel" value="Cancel" /><input type="button" class="button modalyes" value="Yes do it" />');
 d&&!k&&(c+='<input type="button" class="button modalyes" value="OK" />');c=a(c+"</div>\x3c!--pure--\x3e</div></div>");c.hide();a("body").append(c);if(d)a(".modalyes").on("click",function(b){b.preventDefault();k&&n(k,"modalconfirm=1&redirectto="+location.pathname.replace(cashAdminPath,""));a(".modalbg").remove()});else window.setTimeout(function(){a(".modalbg").remove()},2E3);a(".modalbg").fadeIn("fast")}function w(){a(document).scrollTop()<p&&(p=a(document).scrollTop(),0>p&&(p=0),a(".modallightbox").css("top",
 p+"px"))}function F(b,c){jQuery.post(b,"data_only=1",function(b){var k="";c&&(k="returntocurrentroute ");var e=a(".modallightbox").length;e?(b="<h4>"+b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div>',a(".modallightbox").html(b)):(b='<div class="modalbg">&nbsp;</div><div class="modallightbox '+k+'"><h4>'+b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div></div></div>',
 b=a(b),b.hide(),a("body").append(b),A('<i class="icon icon-chevron-sign-up"></i>Hide','<i class="icon icon-chevron-sign-down"></i>Show'),p=a(document).scrollTop(),a(".modallightbox").css("top",p+"px"));B();a(document).bind("scroll",w);D();e?(u(),v()):(a(".modalbg").fadeIn("fast"),a(".modallightbox").fadeIn("fast",function(){u();v()}))},"json")}function D(){f=1;a(".modallightbox form.multipart").each(function(){h=a(this);q=a(this).children("input[type=submit]")[0];l=a(this).data("parts");a(".modallightbox form.multipart div.section").each(function(){a(this).hasClass("part-"+
 f)&&l||a(this).hide()});m=a('<h5 class="steps">Step 1 of '+l+": "+a(a(h).children(".part-"+f)[0]).data("section-name")+"</h5>");l?a(q).hide():(a(a(h).children(".section.basic-information")[0]).fadeIn(),a(m).text("Finalize: "+a(a(h).children(".section.basic-information")[0]).data("section-name")));m.insertBefore(a(this));for(var b=1;b<=l;b++)U(b)})}function U(b){var c=a('<div class="row"></div>'),d=a('<div class="twelve columns"></div>');a(c).append(d);b<=l&&(1<b&&a(d).append(a('<button class="button multipart-prev">Previous</button> ')),
 a(d).append('<button class="button multipart-next">Next</button>'),a(a(h).children(".part-"+b)[0]).append(c))}function A(b,c,d,k){a(".drawer").each(function(){var e,g,f,h;e=a(this);0==e.find(".drawerhandleaction").length&&(e.hasClass("noprefix")?(a.data(e,"labelTextHidden",""),a.data(e,"labelTextVisible","")):(a.data(e,"labelTextHidden",c),a.data(e,"labelTextVisible",b)),g=e.find(".drawerhandle"),f=e.find(".drawercontent"),h=a('<span class="drawerhandleaction">'+a.data(e,"labelTextHidden")+" </span>"),
 d&&h.addClass(k),e.hasClass("defaultopen")||f.hide(),g.prepend(h),a(this).find(".drawerhandle").on("click",function(){a(this).blur();f.is(":hidden")?f.slideDown(200,function(){h.html(a.data(e,"labelTextVisible")+" ");d&&(h.removeClass(),h.addClass(d))}):f.slideUp(200,function(){f.hide();h.html(a.data(e,"labelTextHidden")+" ");k&&(h.removeClass(),h.addClass(k))})}))})}function v(){a("div.scalar").each(function(b){a(this).hide();b=a('<a href="#" class="clonebutton"><i class="icon icon-circle-plus"></i>'+
 a(this).data("actiontext")+"</a>");var c=a(this).html(),d=0+Number(a(this).data("clonecount")),f=a(this).data("name"),e=a(this).nextAll("div.clonedscalar");e.length?e.last().after(b):a(this).after(b);b.click(function(b){b.preventDefault();b=a('<div class="clonedscalar">'+c+"</div>");b.find("*").each(function(){a(this).attr("name")&&(a(this).attr("name",a(this).attr("name")+"-clone-"+f+"-"+d),a(this).attr("id",a(this).attr("id")+"-clone-"+f+"-"+d))});d++;var e=a('<a href="#" class="removescalar"><div class="icon icon-plus"></div></a>');
 b.append(e);a(this).before(b)})})}function R(){a(document).on("click","a.removescalar",function(b){b.preventDefault();var c=a(this).parent(".clonedscalar");c.fadeOut(400,function(){c.detach()})})}function P(){a(document).on("keydown","textarea.taller",function(b){if(9===b.keyCode){b=this.selectionStart;end=this.selectionEnd;var c=a(this);c.val(c.val().substring(0,b)+"\t"+c.val().substring(end));this.selectionStart=this.selectionEnd=b+1;return!1}})}function T(){a(document).on("input","form.add_variants #primary_variant_name",
 function(b){var c=a("#primary_variant_name").val();c?(a("form.add_variants div.variant1").addClass("pure-u-md-1-2"),a("form.add_variants div.variant2").css("display","inline-block"),a("form.add_variants .findreplace").each(function(){-1!==a(this).data("startvalue").indexOf("[primary_variant_name]")&&a(this).text(a(this).data("startvalue").replace("[primary_variant_name]",c))})):(a("form.add_variants div.variant1").removeClass("pure-u-md-1-2"),a("form.add_variants div.variant2").css("display","none"))});
 a(document).on("input","form.add_variants #secondary_variant_name",function(b){var c=a("#secondary_variant_name").val();c?(a("form.add_variants div.variant1-options").addClass("pure-u-md-1-2"),a("form.add_variants div.variant2-options").css("display","inline-block"),a("form.add_variants .findreplace").each(function(){-1!==a(this).data("startvalue").indexOf("[secondary_variant_name]")&&a(this).text(a(this).data("startvalue").replace("[secondary_variant_name]",c))})):(a("form.add_variants div.variant1-options").removeClass("pure-u-md-1-2"),
 a("form.add_variants div.variant2-options").css("display","none"))})}a(document).ready(function(){L();z();FastClick.attach(document.body);window.globaltimeout=!1;history.pushState(1,null,location.pathname);window.addEventListener("popstate",function(a){a.state&&n(location.pathname,null,null,null,!0)},!1)});var C,p=0;h=null;f=1;l=0;m=q=null})(jQuery);
