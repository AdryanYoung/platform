/**
 * JavaScript behaviors for the CASH admin
 * Copyright (c) 2015, CASH Music
 * See jquery.admin.full.js for full LICENSE
 *
 **/
jQuery.fn.extend({insertAtCaret:function(a){return this.each(function(d){if(document.selection)this.focus(),document.selection.createRange().text=a,this.focus();else if(this.selectionStart||"0"==this.selectionStart){d=this.selectionStart;var h=this.selectionEnd,r=this.scrollTop;this.value=this.value.substring(0,d)+a+this.value.substring(h,this.value.length);this.focus();this.selectionStart=d+a.length;this.selectionEnd=d+a.length;this.scrollTop=r}else this.value+=a,this.focus()})}});
(function(a){var d,h,r,n,t;function z(b,c,e,f,k){a.ajax({type:"POST",url:b,data:c+"data_only=1",success:function(g){g?(g.initiallogin&&(a("body").removeClass("login"),a("#loadingmask").css("width","1%")),g.template_name&&0<=g.template_name.toLowerCase().indexOf("login")&&(a("body").addClass("login"),history.pushState(1,null,cashAdminPath+"/")),"doredirect"in g||(g.doredirect=!1),g.doredirect?g.showerror?p(g.location,!1,g.showerror):g.showmessage?p(g.location,!1,!1,g.showmessage):p(g.location):(e&&
(g.error_message=e),f&&(g.page_message=f),a("#mainspc, #pagetitle, #page").removeClass(),a("#mainspc, #page").addClass(g.specialcolor),H(g.section_name),a("#pagemessage").html(""),g.error_message&&u(g.error_message,"Error",!0),g.page_message&&u(g.page_message,""),""!=g.ui_page_tip?(a("#learn_tip").html(g.ui_page_tip),a("#learn_tip").css("display","block")):a("#learn_tip").css("display","none"),a("#learn_text").html(g.ui_learn_text),a("#page_content").html(g.content),a("#pagetitle span").html(g.ui_title),
window.scrollTo(0,0),a(document).trigger("redraw"),k||history.pushState(1,null,b),A()),a("#ajaxloading, #logo, #hero, #learnpanel, #settingspanel, #helppanel").removeClass("loading"),a("#pagedisplay").fadeTo(200,1)):z(b,c,e,f,k)},error:function(a,b,c){console.log(b+": "+c)},dataType:"json"})}function p(b,c,e,f,k){c=c?c+"&":"";a(".modallightbox").fadeOut("fast",function(){a(".modallightbox").remove()});a(".modalbg").fadeOut("fast",function(){a(".modalbg").remove()});v();a("#ajaxloading, #logo, #hero, #learnpanel, #settingspanel, #helppanel").addClass("loading");
a("#pagedisplay").fadeTo(100,.2,function(){z(b,c,e,f,k)})}function A(){v();B('<div class="icon icon-arw-up"></div>\x3c!--icon--\x3eHide','<div class="icon icon-arw-dwn"></div>\x3c!--icon--\x3eShow');a("input[type=date],input.date").datepicker();w();I();J();K();C();L()}function M(){N();O();P();Q();R();S();a(document).on("click","#tipslink",function(b){b.preventDefault();a("#pagetips").slideDown(200)});a(document).on("click","#tipscloselink",function(b){b.preventDefault();a("#pagetips").slideUp(100)});
a(document).on("swipeleft","#page",function(b){a("body").removeClass("swiperight");a("body").hasClass("swipeleft")||a("body").hasClass("swiperight")||a("body").addClass("swipeleft")});a(document).on("swiperight","#page",function(b){a("body").removeClass("swipeleft");a("body").hasClass("swipeleft")||a("body").hasClass("swiperight")||a("body").addClass("swiperight")});a(document).on("click","#menutoggle",function(b){a("#menutoggle").toggleClass("display");a("#navmenu").toggleClass("display")});a(document).on("click",
"#searchbtn",function(b){a("#searchbtn").toggleClass("display");a("#search").toggleClass("display")});a(document).on("click","#flipback",function(b){a("#flipback").parent().removeClass("display");v()});a(document).on("click","input.externalsubmit",function(b){a(a(this).data("cash-target-form")).submit()});a(document).on("change","#current-campaign",function(b){a(this).closest("form").submit()});a(document).on("change","#current-published-campaign",function(b){a(this).find(":selected").data("template")?
u("","This will change your public page. Are you sure?",!0,a(this).find(":selected").data("path")):u("","Before you can publish this campaign, you need to set its page theme. Open the campaign and click the edit icon to start.",!0)});a(document).on("click",".codearea",function(a){element=this;if(document.body.createTextRange)a=document.body.createTextRange(),a.moveToElementText(element),a.select();else if(window.getSelection){var c=window.getSelection();a=document.createRange();a.selectNodeContents(element);
c.removeAllRanges();c.addRange(a)}});a(document).on("click",".multipart-next",function(b){b.preventDefault();var c=!1;a(a(h).children(".part-"+d)[0]).find("input,select,textarea").each(function(){if(!D.element(a(this)))return c=!0,!1});c||(a(h.children(".part-"+d)[0]).hide(),d+=1,d>n?(a(a(h).children(".section.basic-information")[0]).fadeIn(),a(t).text("Finalize: "+a(a(h).children(".section.basic-information")[0]).data("section-name")),a(r).show()):(a(a(h).children(".part-"+d)[0]).fadeIn(),a(t).text("Step "+
d+" of "+n+": "+a(a(h).children(".part-"+d)[0]).data("section-name"))))});a(document).on("click",".multipart-prev",function(b){b.preventDefault();a(h.children(".part-"+d)[0]).hide();--d;a(a(h).children(".part-"+d)[0]).fadeIn();a(t).text("Step "+d+" of "+n+": "+a(a(h).children(".part-"+d)[0]).data("section-name"))});a(document).on("click",'.store a[href^="'+cashAdminPath+'/elements/add"]',function(b){b.preventDefault();b.stopPropagation();jQuery.post(this.href,"data_only=1",function(b){a("div.modallightbox").html("<h4>"+
b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div>');a(".store .modallightbox h4").css("width","62%");a(document).bind("scroll",x);E();w()},"json")});a(document).on("click",".revealpassword",function(b){b.preventDefault();a(b.target).prev('input[type="password"]').attr("value");a(b.target).parent().children(".needsreveal").each(function(){var b=a(this).prop("value");
"password"==a(this).prop("type")?a(this).attr("type","text"):a(this).attr("type","password");a(this).attr("value",b)})});a(document).on("mouseenter",".featured-release",function(b){a("#card",this).addClass("flipped")});a(document).on("mouseleave",".featured-release",function(b){a("#card",this).removeClass("flipped")});a(document).on("click",".toggle",function(b){a(this).parent().toggleClass("display")});a(document).on("click",".paneltitle",function(a){v()});a(document).on("click","#learn.toggle, #learnpanel .toggle",
function(b){a("body").removeClass("help").removeClass("settings");a(this).parents("body").addClass("panel").addClass("learn")});a(document).on("click","#settings.toggle, #settingspanel .toggle, .settings.toggle",function(b){a("body").removeClass("help").removeClass("learn");a(this).parents("body").addClass("panel").addClass("settings");a("#settingspanel .tertiarynav li a").removeClass("current");y(cashAdminPath+"/account/");a("#settingspanel .tertiarynav li a:first").addClass("current")});a(document).on("click",
"#help.toggle, #helppanel .toggle",function(b){a("body").removeClass("settings").removeClass("learn");a(this).parents("body").addClass("panel").addClass("help");a("#helppanel .tertiarynav li a").removeClass("current");y(cashAdminPath+"/help/");a("#helppanel .tertiarynav li a:first").addClass("current")});a(document).on("click",".swipehint",function(b){a(this).addClass("hide")})}function y(b){a.post(b,"data_only=1",function(b){a("body").hasClass("help")?a("#helppanel .panelcontent").html(a(b.content)):
a("body").hasClass("settings")&&a("#settingspanel .panelcontent").html(a(b.content));w()})}function v(){a("body").removeClass("panel").removeClass("help").removeClass("settings").removeClass("learn")}function K(){if(a("#cnvs").length){var b=a("#cnvs").data("seed");if(b){var c=b.toString().split("").reverse(),b=Math.ceil((Number(c[0])+1)/2),e=Math.ceil((Number(c[1])+1)/2),f="250,56,102 106,56,250 255,124,18 250,56,56 0,207,127 250,56,102 106,56,250 255,124,18 250,56,56 0,207,127".split(" "),k=["0.9",
"0.6","0.3"],g=[9,24,60,980,120,180,210,240,270,330],d=new Image;d.src=cashAdminPath+"/assets/images/glitch/background/glitch"+b+".jpg";d.addEventListener("load",function(){var b=a("#cnvs").width(),h=a("#cnvs").height(),m=document.getElementById("cnvs").getContext("2d");m.drawImage(d,0,0);olay=new Image;olay.src=cashAdminPath+"/assets/images/glitch/artist/artist"+e+".jpg";olay.addEventListener("load",function(){m.globalCompositeOperation="screen";for(var e=0;2E3>e;)m.drawImage(olay,olay.width/(5*
(Number(c[2])+1))+e/3,0,g[Number(c[2])],h,e,0,g[Number(c[2])],h),e+=g[Number(c[2])];m.save();m.globalCompositeOperation="hard-light";e=m.createLinearGradient(0,0,a("#cnvs").width()/2,0);e.addColorStop(0,"rgba("+f[Number(c[3])]+","+k[Number(c[3])%3]+")");e.addColorStop(1,"rgba("+f[Number(c[4])]+","+k[Number(c[3])%3]+")");m.fillStyle=e;m.fillRect(0,0,b,h);m.restore();a("#cnvs").addClass("display")},!1)},!1)}}}function S(){a(document).on("mouseenter",".elementdisplay",function(b){b.preventDefault();
var c=a(this).attr("name");window.globaltimeout=window.setTimeout(function(){a(".gallery").stop().animate({scrollLeft:Math.floor(a(c).position().left)-34},"slow")},150);a(".example").removeClass("current");a(".gallery "+c).addClass("current")});a(document).on("mouseleave",".elementdisplay",function(a){a.preventDefault();window.globaltimeout&&window.clearTimeout(window.globaltimeout)})}function C(){ZeroClipboard.config({swfPath:cashAdminPath+"/ui/default/assets/flash/ZeroClipboard.swf"});var b=new ZeroClipboard(a(".copy"));
b.on("ready",function(a){b.on("aftercopy",function(a){alert("Embed Code Copied To Clipboard.")})})}function N(){a(document).on("click",'a[href^="'+cashAdminPath+'"]',function(b){var c=a(b.currentTarget);b.altKey||b.ctrlKey||b.metaKey||b.shiftKey||c.hasClass("lightboxed")||c.hasClass("needsconfirmation")||c.hasClass("showelementdetails")||c.hasClass("noajax")||c.parents("div").hasClass("inner")||a("body").hasClass("store")||!c.attr("href").indexOf("elements/add")||a("body").hasClass("page-editor")||
c.hasClass("connection")?!c.parents("div").hasClass("inner")||c.hasClass("connection")||c.hasClass("lightboxed")||c.hasClass("needsconfirmation")?c.hasClass("store")?(b.preventDefault(),a("body").addClass("store")):c.hasClass("page-editor")&&(b.preventDefault(),a("body").addClass("page-editor")):(b.preventDefault(),a(".panelcontent").removeClass("display"),b=c.attr("href"),y(b),a(".panelcontent").addClass("display"),a(".inner a").removeClass("current"),c.addClass("current"),c.blur()):(b.preventDefault(),
b=c.attr("href"),p(b),c.blur())})}function w(){a("form").each(function(){D=a(this).validate({errorClass:"invalid",errorElement:"span",highlight:function(b,c){a(b).addClass(c);a(b.form).find("label[for="+b.id+"]").addClass(c)},unhighlight:function(b,c){a(b).removeClass(c);a(b.form).find("label[for="+b.id+"]").removeClass(c)},submitHandler:function(b){if(1>a(b).attr("action").toLowerCase().indexOf("s3.amazonaws")&&!a(b).hasClass("noajax")){b=a(b);var c=b.attr("action");""==c&&(c=location.pathname);
var e=a(b).serialize();b.hasClass("returntocurrentroute")&&(e+="&forceroute="+location.pathname.replace(cashAdminPath,""));p(c,e)}else b.submit()}})})}function H(b){b!=currentSection&&(currentSection=b,a("div.mainnavmenu li").each(function(c){a(this).removeClass("current");a(this).hasClass(b+"nav")&&a(this).addClass("current")}),a("div.mainnavmenu a").each(function(c){a(this).hasClass(b+"nav")&&a(this).parent().addClass("current")}))}function J(){a("#connection_id").each(function(){if(0<this.value){var b=
a(".file-upload-trigger").data("upload-endpoint")+this.value;a(".upload-corral").fadeIn().find(".file-upload-trigger").data("upload-endpoint",b)}})}function O(){a(document).on("click","a[data-publicize-endpoint]",function(b){b.preventDefault();a.ajax({url:a(this).data("publicize-endpoint"),dataType:"json"}).done(function(a){}).complete(function(b){b=a.parseJSON(b.responseText);b.success&&(a("#asset_location").val(b.location),a("#connection_id").val("0"),a(".upload-corral").fadeOut())})});a(document).on("change",
"#connection_id",function(b){if(0<this.value){b=a(".file-upload-trigger").data("upload-endpoint")+this.value;var c=a(".upload-corral").fadeIn().find(".file-upload-trigger");c.data("upload-endpoint",b);a.ajax({url:b,dataType:"json",data:"data_only=1"}).done(function(a){c.parents(".drawer").find(".drawercontent").html(a.content)})}else a(".upload-corral").fadeOut()});a(document).on("click",".file-upload-trigger",function(b){b.preventDefault();b=a(this);a(this).data("upload-endpoint");if("0"==a("#connection_id").val())return alert("Sorry, can't upload without a connection. Have you tried a normal link?"),
!1;b.parents(".fadedtext").css("height","0px");b.parents(".fadedtext").animate({opacity:0})})}function I(){a(".autocomplete").each(function(){var b=a(this).data("cash-endpoint-url");a(this).autocomplete({source:function(c,e){a.ajax({url:b+"/"+c.term,dataType:"json",error:function(a){},success:function(b){e(a.map(b,function(a){return{label:a.displayString,value:a.displayString,id:a.id}}))}})},select:function(b,e){a("#event_venue").val(e.item.id)},minLength:2})})}function P(){a(document).on("click",
".modalcancel, .modalskip",function(a){a.preventDefault();F()});a(document).on("click",".page-description",function(b){a("body").hasClass("settings")||a("body").hasClass("help")?(a("body").removeClass("settings").removeClass("help"),a("body").addClass("learn"),a(this).addClass("display")):a("body").hasClass("learn")?(a("body").removeClass("panel"),window.globaltimeout=window.setTimeout(function(){a("body").removeClass("learn").removeClass("settings").removeClass("help")},250)):(a(this).parents("body").addClass("learn").addClass("panel"),
a(this).addClass("display"))});a(document).keyup(function(a){27===a.keyCode&&F()})}function F(){a(".modallightbox").fadeOut("fast",function(){a(".modallightbox").remove();openlightbox=!1});a(".modalbg").fadeOut("fast",function(){a(".modalbg").remove();a("body").removeClass("store page-editor")});a(document).unbind("scroll",x)}function R(){a(document).on("click",".needsconfirmation",function(b){b.preventDefault();u("","Are you sure?",!0,a(this).attr("href"));this.blur()});a(document).on("click",".lightboxed",
function(b){b.preventDefault();a(this).hasClass("closepanel")&&v();a(this).hasClass("returntocurrentroute")?G(a(this).attr("href"),!0):G(a(this).attr("href"));this.blur()})}function L(){a("div.switchblock").each(function(){var b=a(a(this).data("watch"));if(b){var c=a(this).data("change");b.change(function(){a(c).addClass("show")});var e=b.val(),f=a(this).data("special");if(f&&"object"===typeof f)if(f.val){if(e==f.val&&a(f.target))return a(f.target).addClass("show"),b.change(function(){a(f.target).removeClass("show")}),
!0}else a.each(f,function(c,f){if(e==f.val&&a(f.target))return a(f.target).addClass("show"),b.change(function(){a(f.target).removeClass("show")}),!0});var k=a(this).data("default");a(k).addClass("show");k!==c&&b.change(function(){a(k).removeClass("show")})}})}function u(b,c,e,f){c='<div class="modalbg"><div class="modaldialog"><div class="pure-u-1"><h4>'+c+"</h4>";b&&(c+='<p><span class="big">'+b+"</span></p>");e&&f&&(c+='<input type="button" class="button modalcancel" value="Cancel" /><input type="button" class="button modalyes" value="Yes do it" />');
e&&!f&&(c+='<input type="button" class="button modalyes" value="OK" />');c=a(c+"</div>\x3c!--pure--\x3e</div></div>");c.hide();a("body").append(c);if(e)a(".modalyes").on("click",function(b){b.preventDefault();f&&p(f,"modalconfirm=1&redirectto="+location.pathname.replace(cashAdminPath,""));a(".modalbg").remove()});else window.setTimeout(function(){a(".modalbg").remove()},2E3);a(".modalbg").fadeIn("fast")}function x(){a(document).scrollTop()<q&&(q=a(document).scrollTop(),0>q&&(q=0),a(".modallightbox").css("top",
q+"px"))}function G(b,c){jQuery.post(b,"data_only=1",function(b){var f="";c&&(f="returntocurrentroute ");var d=a(".modallightbox").length;d?(b="<h4>"+b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div>',a(".modallightbox").html(b)):(b='<div class="modalbg">&nbsp;</div><div class="modallightbox '+f+'"><h4>'+b.ui_title+"</h4>"+b.content+'<div class="tar" style="position:relative;z-index:9876;"><a href="#" class="modalcancel smalltext"><div class="icon icon-plus"></div>\x3c!--icon--\x3e</a></div></div></div>',
b=a(b),b.hide(),a("body").append(b),B('<i class="icon icon-chevron-sign-up"></i>Hide','<i class="icon icon-chevron-sign-down"></i>Show'),q=a(document).scrollTop(),a(".modallightbox").css("top",q+"px"));C();a(document).bind("scroll",x);E();d?w():(a(".modalbg").fadeIn("fast"),a(".modallightbox").fadeIn("fast",function(){w()}))},"json")}function E(){d=1;a(".modallightbox form.multipart").each(function(){h=a(this);r=a(this).children("input[type=submit]")[0];n=a(this).data("parts");a(r).hide();a(".modallightbox form.multipart div.section").each(function(){a(this).hasClass("part-"+
d)||a(this).hide()});t=a('<h5 class="steps">Step 1 of '+n+": "+a(a(h).children(".part-"+d)[0]).data("section-name")+"</h5>");t.insertBefore(a(this));for(var b=1;b<=n;b++)T(b)})}function T(b){var c=a('<div class="row"></div>'),e=a('<div class="twelve columns"></div>');a(c).append(e);b<=n&&(1<b&&a(e).append(a('<button class="button multipart-prev">Previous</button> ')),a(e).append('<button class="button multipart-next">Next</button>'),a(a(h).children(".part-"+b)[0]).append(c))}function B(b,c,e,f){a(".drawer").each(function(){var d,
g,h,l;d=a(this);0==d.find(".drawerhandleaction").length&&(d.hasClass("noprefix")?(a.data(d,"labelTextHidden",""),a.data(d,"labelTextVisible","")):(a.data(d,"labelTextHidden",c),a.data(d,"labelTextVisible",b)),g=d.find(".drawerhandle"),h=d.find(".drawercontent"),l=a('<span class="drawerhandleaction">'+a.data(d,"labelTextHidden")+" </span>"),e&&l.addClass(f),h.hide(),g.prepend(l),a(this).find(".drawerhandle").on("click",function(){a(this).blur();h.is(":hidden")?h.slideDown(200,function(){l.html(a.data(d,
"labelTextVisible")+" ");e&&(l.removeClass(),l.addClass(e))}):h.slideUp(200,function(){h.hide();l.html(a.data(d,"labelTextHidden")+" ");f&&(l.removeClass(),l.addClass(f))})}))})}function Q(){a(document).on("keydown","textarea.taller",function(b){if(9===b.keyCode){b=this.selectionStart;end=this.selectionEnd;var c=a(this);c.val(c.val().substring(0,b)+"\t"+c.val().substring(end));this.selectionStart=this.selectionEnd=b+1;return!1}})}a(document).ready(function(){M();A();FastClick.attach(document.body);
window.globaltimeout=!1;history.pushState(1,null,location.pathname);window.addEventListener("popstate",function(a){a.state&&p(location.pathname,null,null,null,!0)},!1)});var D,q=0;h=null;d=1;n=0;t=r=null})(jQuery);